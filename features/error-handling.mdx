---
title: "错误处理"
description: "理解和处理 API 错误"
---

## 错误响应格式

所有错误响应遵循统一格式：

```json
{
  "error": "ErrorType",
  "message": "Human-readable error message",
  "details": {
    "key": "additional info"
  },
  "statusCode": 400,
  "correlationId": "req_abc123"
}
```

## HTTP 状态码

| 状态码 | 类型                | 说明           |
| ------ | ------------------- | -------------- |
| 400    | BadRequest          | 请求参数错误   |
| 401    | Unauthorized        | 认证失败       |
| 403    | Forbidden           | 权限不足       |
| 404    | NotFound            | 资源不存在     |
| 409    | Conflict            | 资源冲突       |
| 429    | RateLimitExceeded   | 超过速率限制   |
| 500    | InternalServerError | 服务器内部错误 |
| 503    | ServiceUnavailable  | 服务暂时不可用 |

## 常见错误

### 401 Unauthorized

**原因**：API Key 无效或缺失

```json
{
  "error": "Unauthorized",
  "message": "Invalid or missing API key",
  "statusCode": 401,
  "correlationId": "req_abc123"
}
```

**解决方案**：

1. 检查 API Key 是否正确
2. 确认 Authorization 头格式：`Bearer YOUR_API_KEY`
3. 验证 API Key 是否已过期

### 403 Forbidden

**原因**：模型或工具不在许可列表中

```json
{
  "error": "Forbidden",
  "message": "Model not available with your API key",
  "statusCode": 403,
  "correlationId": "req_def456"
}
```

**解决方案**：

- 使用 `GET /api/v1/models` 查看可用模型
- 使用 `GET /api/v1/tools` 查看可用工具
- 联系管理员升级权限

### 400 BadRequest - 缺少必需上下文

**原因**：工具缺少必需的上下文参数

```json
{
  "error": "BadRequest",
  "message": "Missing required context: configData, replyPrompts",
  "details": {
    "missingContext": ["configData", "replyPrompts"],
    "tools": ["zhipin_reply_generator"]
  },
  "statusCode": 400,
  "correlationId": "req_ghi789"
}
```

**解决方案**：

1. 使用 `GET /api/v1/tools` 查看工具的 `requiredContext`
2. 在 `context` 或 `toolContext` 中提供缺失的字段
3. 或使用 `contextStrategy: "skip"` 跳过该工具

### 429 RateLimitExceeded

**原因**：超过 API 调用速率限制

```json
{
  "error": "RateLimitExceeded",
  "message": "Rate limit exceeded. Please retry after 10 seconds.",
  "statusCode": 429,
  "retryAfter": 10,
  "correlationId": "req_jkl012"
}
```

**解决方案**：

- 实现指数退避重试策略
- 减少并发请求数
- 联系销售团队提升限额

### 500 InternalServerError

**原因**：服务器内部错误

```json
{
  "error": "InternalServerError",
  "message": "An unexpected error occurred",
  "statusCode": 500,
  "correlationId": "req_mno345"
}
```

**解决方案**：

- 使用 `correlationId` 联系技术支持
- 稍后重试
- 检查服务状态页

## 错误处理最佳实践

<AccordionGroup>
  <Accordion title="使用 try-catch 包裹请求">
    ```javascript
    try {
      const response = await fetch(url, options);

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`API Error: ${error.message}`);
      }

      const data = await response.json();
      return data;
    } catch (error) {
      console.error('请求失败:', error);
      // 向用户展示友好的错误信息
    }
    ```

  </Accordion>

  <Accordion title="实现重试机制">
    ```javascript
    async function fetchWithRetry(url, options, maxRetries = 3) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(url, options);

          if (response.status === 429) {
            const retryAfter = response.headers.get('Retry-After') || 5;
            await sleep(retryAfter * 1000);
            continue;
          }

          return response;
        } catch (error) {
          if (i === maxRetries - 1) throw error;
          await sleep(Math.pow(2, i) * 1000); // 指数退避
        }
      }
    }
    ```

  </Accordion>

  <Accordion title="记录 correlationId">
    ```javascript
    const response = await fetch(url, options);
    const data = await response.json();

    if (!response.ok) {
      console.error('Error correlationId:', data.correlationId);
      // 记录到日志系统，便于排查问题
    }
    ```

  </Accordion>

  <Accordion title="区分错误类型">
    ```javascript
    function handleError(error) {
      switch (error.statusCode) {
        case 401:
          // 重新认证
          redirectToLogin();
          break;
        case 403:
          // 权限不足提示
          showPermissionError();
          break;
        case 429:
          // 限流提示
          showRateLimitWarning();
          break;
        case 500:
          // 服务器错误
          showServerError(error.correlationId);
          break;
        default:
          showGenericError();
      }
    }
    ```
  </Accordion>
</AccordionGroup>

## 完整示例

<CodeGroup>

```javascript JavaScript
async function safeChat(message, options = {}) {
  const maxRetries = 3;
  let lastError = null;

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const response = await fetch("https://huajune.duliday.com/api/v1/chat", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "anthropic/claude-3-7-sonnet-20250219",
          messages: [{ role: "user", content: message }],
          ...options,
        }),
      });

      if (response.status === 429) {
        const retryAfter = parseInt(response.headers.get("Retry-After") || "5");
        console.log(`Rate limited, retrying after ${retryAfter}s`);
        await new Promise((resolve) => setTimeout(resolve, retryAfter * 1000));
        continue;
      }

      const data = await response.json();

      if (!response.ok) {
        console.error(`Error (${data.correlationId}):`, data.message);
        throw new Error(data.message);
      }

      return data;
    } catch (error) {
      lastError = error;

      if (attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000;
        console.log(`Attempt ${attempt + 1} failed, retrying in ${delay}ms`);
        await new Promise((resolve) => setTimeout(resolve, delay));
      }
    }
  }

  throw lastError;
}

// 使用
try {
  const result = await safeChat("你好");
  console.log(result.data.messages[0].parts[0].text);
} catch (error) {
  console.error("聊天失败:", error.message);
}
```

```python Python
import requests
import time

def safe_chat(message, options=None, max_retries=3):
    url = "https://huajune.duliday.com/api/v1/chat"
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": "anthropic/claude-3-7-sonnet-20250219",
        "messages": [{"role": "user", "content": message}],
        **(options or {})
    }

    last_error = None

    for attempt in range(max_retries):
        try:
            response = requests.post(url, json=payload, headers=headers)

            if response.status_code == 429:
                retry_after = int(response.headers.get('Retry-After', 5))
                print(f"Rate limited, retrying after {retry_after}s")
                time.sleep(retry_after)
                continue

            data = response.json()

            if not response.ok:
                print(f"Error ({data.get('correlationId')}): {data.get('message')}")
                raise Exception(data.get('message'))

            return data
        except Exception as error:
            last_error = error

            if attempt < max_retries - 1:
                delay = 2 ** attempt
                print(f"Attempt {attempt + 1} failed, retrying in {delay}s")
                time.sleep(delay)

    raise last_error

# 使用
try:
    result = safe_chat('你好')
    print(result['data']['messages'][0]['parts'][0]['text'])
except Exception as error:
    print(f"聊天失败: {error}")
```

</CodeGroup>

## 调试技巧

<CardGroup cols={2}>
  <Card title="记录 correlationId" icon="fingerprint">
    保存每个请求的 `correlationId`，便于问题排查
  </Card>

{" "}
<Card title="使用 validateOnly" icon="check">
  在正式调用前验证参数配置
</Card>

{" "}
<Card title="监控错误率" icon="chart-line">
  跟踪不同类型错误的发生频率
</Card>

  <Card title="日志记录" icon="file-lines">
    记录完整的请求和响应，便于复现问题
  </Card>
</CardGroup>

## 下一步

<CardGroup cols={2}>
  <Card
    title="认证说明"
    icon="key"
    href="/authentication"
  >
    了解 API 认证机制
  </Card>

  <Card
    title="调试技巧"
    icon="bug"
    href="/best-practices/debugging"
  >
    学习更多调试方法
  </Card>
</CardGroup>
